<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histori Penggunaan</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Style di sini tidak diubah karena sudah rapi */
        body {
            margin: 0;
            padding: 0;
            background: #F5F5F5;
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 390px;
            padding: 20px;
            background: #F5F5F5;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }
        .histori-penggunaan {
            font-family: 'Luckiest Guy', cursive;
            font-size: 25px;
            color: #4A90E2;
            text-align: center;
            text-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
        }
        .kalender {
            margin-top: 20px;
            background: #7B93F0;
            border-radius: 20px;
            padding: 20px;
            box-sizing: border-box;
            width: 100%;
            max-width: 350px;  /* Pastikan kalender dan grafik memiliki lebar maksimal yang sesuai */
        }
        .grafik-penggunaan {
            margin-top: 20px;
            background: #7B93F0;
            border-radius: 20px;
            padding: 20px;
            box-sizing: border-box;
            width: 100%;
            max-width: 350px;  /* Pastikan grafik tidak lebih lebar dari kalender */
        }
        #weekdays, #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* Membuat 7 kolom untuk setiap hari dalam seminggu */
            gap: 5px;
            padding: 5px;
            text-align: center;
        }
        #weekdays {
            margin-bottom: 5px; /* Memberi jarak antara nama hari dan kotak tanggal */
        }
        .day-name {
            font-weight: bold;
            color: #ffffff;
            margin-left: 2px;
        }        
        #calendar-controls {
            display: flex;
            justify-content: space-around; /* Menjaga judul bulan tetap di tengah */
            align-items: center; /* Memastikan elemen di tengah secara vertikal */
            width: 100%;
            padding: 0 10px;
        }
        #prevMonth, #nextMonth {
            background-color: transparent;
            border: none;
            color: #ffffff;
            font-size: 30px; /* Memperbesar ukuran panah */
            cursor: pointer;
            padding: 5px;
            text-align: center;
            margin: 0 10px; /* Memberi jarak antara panah dan judul bulan */
        }        
        #calendar-title {
            font-weight: bold;
            font-size: 18px; /* Menyesuaikan ukuran font */
            text-align: center;
            color: #ffffff;
            width: 100%;  /* Pastikan lebar 100% agar posisi tetap di tengah */
        }
        .grafik-penggunaan canvas {
            width: 100%;
            height: 200px;
        }
        .penggunaan, .dominan, .waktu {
            font-family: 'Poppins', sans-serif;
            font-size: 20px;
            color: #7B93F0;
            text-align: center;
            margin-top: 10px;
            text-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
        }
        .rectangle2 {
            width: 75px;
            height: 31px;
            background: #7B93F0;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-top: 20px;
        }
        .tombol-back {
            width: 24px;
            height: 24px;
            background: url('panah.png') no-repeat center/cover;
        }
        @media (max-width: 600px) {
            .histori-penggunaan { font-size: 22px; }
            .kalender, .grafik-penggunaan { padding: 15px; }
            .penggunaan, .dominan, .waktu { font-size: 18px; }
        }
        .day-box {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f1f1f1;
            border-radius: 50%;
            cursor: pointer;
        }
        .day-box.empty { background-color: transparent; cursor: default; }
        .intensity-0 { background-color: #f1f1f1; }   /* Putih */
        .intensity-1 { background-color: #A0D0FF; }   /* Biru muda */
        .intensity-2 { background-color: #70AFFF; }   /* Biru sedikit lebih gelap */
        .intensity-3 { background-color: #4080FF; }   /* Biru sedang */
        .intensity-4 { background-color: #0060FF; }   /* Biru gelap */
        
    </style>
</head>
<body>

<div class="container">
    <div class="histori-penggunaan">HISTORY</div>

    <div class="kalender">
        <div id="calendar-controls">
            <button id="prevMonth">←</button>
            <div id="calendar-title">Month</div>
            <button id="nextMonth">→</button>
        </div>
        <div id="weekdays">
            <div class="day-name">Mon</div>
            <div class="day-name">Tue</div>
            <div class="day-name">Wed</div>
            <div class="day-name">Thu</div>
            <div class="day-name">Fri</div>
            <div class="day-name">Sat</div>
            <div class="day-name">Sun</div>
        </div>
        <div id="calendar-grid"></div>
    </div>

    <div class="grafik-penggunaan">
        <canvas id="grafik"></canvas>
    </div>

    <div class="penggunaan">Use: <span id="usage">-</span></div>
    <div class="dominan">Dominant: <span id="dominant">-</span></div>
    <div class="waktu">Usage time: <span id="time">-</span></div>

    <div class="rectangle2" onclick="goBack()">
        <div class="tombol-back"></div>
    </div>
</div>

<script>
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let globalHistoryData = {};
    let globalHeatmapData = [];
    let chart;
    let lastClickedDate = null;

    function goBack() {
        window.location.href = "Saran.html";
    }

    function getIntensityClass(value) {
        if (value >= 4) return "intensity-4";
        if (value === 3) return "intensity-3";
        if (value === 2) return "intensity-2";
        if (value === 1) return "intensity-1";
        return "intensity-0";
    }

    function renderCalendar(dataArray, year, month) {
        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";

        const dateMap = {};
        dataArray.forEach(item => {
            const d = new Date(item.start);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            const date = d.toISOString().slice(0, 10);
            dateMap[date] = (dateMap[date] || 0) + 1;
        });

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDay = new Date(year, month, 1).getDay();

        for (let i = 0; i < startDay; i++) {
            const emptyBox = document.createElement("div");
            emptyBox.className = "day-box empty";
            grid.appendChild(emptyBox);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, "0")}-${i.toString().padStart(2, "0")}`;
            const value = dateMap[dateStr] || 0;
            const box = document.createElement("div");
            box.className = `day-box ${getIntensityClass(value)}`;
            box.textContent = i;
            box.title = `${dateStr} - ${value} laporan`;
            box.onclick = () => selectDate(dateStr);
            grid.appendChild(box);
        }

        document.getElementById("calendar-title").textContent = monthNames[month] + " " + year;
    }

    function selectDate(date) {
        if (lastClickedDate === date) {
            document.getElementById("usage").textContent = "-";
            document.getElementById("dominant").textContent = "-";
            document.getElementById("time").textContent = "-";
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update();
            lastClickedDate = null;
            return;
        }

        lastClickedDate = date;

        const selectedData = globalHistoryData[date];
        if (selectedData) {
            document.getElementById("usage").textContent = selectedData.penggunaan;
            document.getElementById("dominant").textContent = selectedData.dominant || "Tidak Dikenal";
            document.getElementById("time").textContent = formatMinutes(selectedData.waktu);

            chart.data.labels = [date];
            chart.data.datasets[0].data = [selectedData.penggunaan];
            chart.update();
        }
    }

    function formatMinutes(minutes) {
        if (minutes < 60) return `${minutes} menit`;
        const jam = Math.floor(minutes / 60);
        const sisaMenit = minutes % 60;
        return `${jam} jam ${sisaMenit} menit`;
    }

    document.getElementById("prevMonth").onclick = () => {
        if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
        } else {
            currentMonth--;
        }
        renderCalendar(globalHeatmapData, currentYear, currentMonth);
    };

    document.getElementById("nextMonth").onclick = () => {
        if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
        } else {
            currentMonth++;
        }
        renderCalendar(globalHeatmapData, currentYear, currentMonth);
    };

    async function fetchData() {
        try {
            const userEmail = localStorage.getItem("user_email");
            if (!userEmail) {
                alert("Email pengguna tidak ditemukan.");
                return;
            }

            const response = await fetch(`http://127.0.0.1:5000/get_history?user_email=${encodeURIComponent(userEmail)}&month=${currentMonth + 1}&year=${currentYear}`);
            if (!response.ok) throw new Error("Gagal mengambil data");

            const data = await response.json();
            globalHeatmapData = data.heatmap || [];

            const usageData = data.usage_data || [];
            const dominantData = Array.isArray(data.dominan) ? data.dominan : [data.dominan];
            const timeData = data.waktu || [];

            data.dates.forEach((date, index) => {
                globalHistoryData[date] = {
                    penggunaan: usageData[index] || 0,
                    dominant: dominantData[index] || "Tidak Dikenal",
                    waktu: timeData[index] || 0
                };
            });

            const ctx = document.getElementById("grafik").getContext("2d");

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const dateLabels = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const usageMap = {};
            data.dates.forEach((date, index) => {
                const parts = date.split("-");
                const day = parseInt(parts[2], 10);
                usageMap[day] = usageData[index];
            });

            const usagePerDay = dateLabels.map(day => usageMap[day] || 0);

            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: dateLabels,
                    datasets: [{
                        label: "Penggunaan",
                        data: usagePerDay,
                        backgroundColor: "#00B8D9",
                        borderColor: "#000",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#000'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: "#000",
                                maxRotation: 0,
                                minRotation: 0
                            },
                            grid: {
                                color: "rgba(0,0,0,0.2)"
                            },
                            border: {
                                color: "#000"
                            },
                            title: {
                                display: true,
                                text: 'Tanggal',
                                color: '#000',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        y: {
                            ticks: {
                                color: "#000"
                            },
                            grid: {
                                color: "rgba(0,0,0,0.2)"
                            },
                            border: {
                                color: "#000"
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            renderCalendar(globalHeatmapData, currentYear, currentMonth);
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    fetchData();
</script>


</body>
</html>
